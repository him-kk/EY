{
  "name": "Vehicle Diagnosis Orchestrator",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "id": "8e6d24ff-571b-4420-89c6-d11184906c80",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -1344,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get list of vehicles that need diagnosis\nconst vehicles = [\n  {\n    vehicle_id: \"V001\",\n    make: \"Toyota\",\n    model: \"Camry\",\n    year: 2020,\n    last_service: \"2023-06-15\"\n  },\n  {\n    vehicle_id: \"V002\", \n    make: \"Honda\",\n    model: \"Civic\",\n    year: 2019,\n    last_service: \"2023-08-20\"\n  },\n  {\n    vehicle_id: \"V003\",\n    make: \"Ford\",\n    model: \"F-150\",\n    year: 2021,\n    last_service: \"2023-11-10\"\n  },\n  {\n    vehicle_id: \"V004\",\n    make: \"Tesla\",\n    model: \"Model 3\",\n    year: 2022,\n    last_service: \"2023-12-01\"\n  }\n];\n\nreturn vehicles.map(vehicle => ({\n  json: {\n    ...vehicle,\n    timestamp: new Date().toISOString(),\n    status: \"pending_diagnosis\"\n  }\n}));"
      },
      "id": "70d8925a-cb04-4078-8dda-2cf061066633",
      "name": "Get Vehicles (Mock)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        208
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "timestamp",
        "include": "allOtherFields",
        "options": {}
      },
      "id": "df309bac-99ff-45ce-8e91-edc4759fe25a",
      "name": "Split Out Vehicles",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -896,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "const vehicle = $input.first().json;\n\n// Generate realistic sensor data based on vehicle\nconst sensorTemplates = {\n  \"V001\": {\n    battery_voltage: 12.8,\n    engine_temp: 92,\n    oil_pressure: 48,\n    fuel_level: 0.7,\n    mileage: 34500,\n    tire_pressure_front: 33,\n    tire_pressure_rear: 32,\n    brake_pad_thickness: 8,\n    transmission_temp: 95\n  },\n  \"V002\": {\n    battery_voltage: 11.4, // Low battery - should trigger critical\n    engine_temp: 105, // High temp\n    oil_pressure: 28, // Low pressure\n    fuel_level: 0.4,\n    mileage: 67000,\n    tire_pressure_front: 31,\n    tire_pressure_rear: 30,\n    brake_pad_thickness: 4, // Worn brakes\n    transmission_temp: 110\n  },\n  \"V003\": {\n    battery_voltage: 12.2,\n    engine_temp: 88,\n    oil_pressure: 52,\n    fuel_level: 0.9,\n    mileage: 12000,\n    tire_pressure_front: 35,\n    tire_pressure_rear: 35,\n    brake_pad_thickness: 12,\n    transmission_temp: 85\n  },\n  \"V004\": {\n    battery_voltage: 13.1, // EV - higher voltage\n    engine_temp: 45, // EV - lower temp\n    oil_pressure: 0, // EV - no oil pressure\n    fuel_level: 0.8,\n    mileage: 8000,\n    tire_pressure_front: 42, // EV - higher pressure\n    tire_pressure_rear: 42,\n    brake_pad_thickness: 10,\n    transmission_temp: 50\n  }\n};\n\nconst sensorData = sensorTemplates[vehicle.vehicle_id] || sensorTemplates[\"V001\"];\n\n// Add patterns based on sensor readings\nconst patterns = [];\nif (sensorData.battery_voltage < 12.0) patterns.push(\"Low battery voltage detected\");\nif (sensorData.engine_temp > 100) patterns.push(\"Engine overheating pattern\");\nif (sensorData.oil_pressure < 30 && sensorData.oil_pressure > 0) patterns.push(\"Low oil pressure\");\nif (sensorData.brake_pad_thickness < 5) patterns.push(\"Brake pads worn\");\nif (sensorData.mileage > 50000) patterns.push(\"High mileage vehicle\");\n\nreturn [{\n  json: {\n    ...vehicle,\n    sensor_data: sensorData,\n    patterns: patterns,\n    data_retrieved_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "eaaa7d6c-4351-4e6d-ab4a-efd4243811d9",
      "name": "Get Sensor Data (Mock)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -688,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// Simulate ML model analysis\nconst sensorData = data.sensor_data;\n\n// Calculate failure scores for different components\nlet batteryScore = 0;\nlet engineScore = 0;\nlet brakeScore = 0;\nlet tireScore = 0;\n\n// Battery analysis\nif (sensorData.battery_voltage < 11.5) batteryScore = 0.95;\nelse if (sensorData.battery_voltage < 12.2) batteryScore = 0.7;\nelse if (sensorData.battery_voltage < 12.6) batteryScore = 0.3;\nelse batteryScore = 0.1;\n\n// Engine analysis\nif (sensorData.engine_temp > 105) engineScore = 0.9;\nelse if (sensorData.engine_temp > 95) engineScore = 0.6;\nelse engineScore = 0.1;\n\nif (sensorData.oil_pressure < 30 && sensorData.oil_pressure > 0) {\n  engineScore = Math.max(engineScore, 0.8);\n}\n\n// Brake analysis\nif (sensorData.brake_pad_thickness < 3) brakeScore = 0.9;\nelse if (sensorData.brake_pad_thickness < 5) brakeScore = 0.7;\nelse if (sensorData.brake_pad_thickness < 7) brakeScore = 0.4;\nelse brakeScore = 0.1;\n\n// Tire analysis\nconst avgTirePressure = (sensorData.tire_pressure_front + sensorData.tire_pressure_rear) / 2;\nif (avgTirePressure < 28) tireScore = 0.8;\nelse if (avgTirePressure < 30) tireScore = 0.5;\nelse tireScore = 0.1;\n\n// Determine the most critical component\nconst components = [\n  { name: \"Battery\", score: batteryScore },\n  { name: \"Engine\", score: engineScore },\n  { name: \"Brakes\", score: brakeScore },\n  { name: \"Tires\", score: tireScore }\n];\n\nconst criticalComponent = components.reduce((max, comp) => comp.score > max.score ? comp : max);\nconst failureProbability = criticalComponent.score;\n\n// Determine priority\nlet priority, timeline, confidence;\nif (failureProbability > 0.8) {\n  priority = \"CRITICAL\";\n  timeline = Math.floor(Math.random() * 3) + 1; // 1-3 days\n  confidence = 0.85 + (Math.random() * 0.1); // 0.85-0.95\n} else if (failureProbability > 0.6) {\n  priority = \"HIGH\";\n  timeline = Math.floor(Math.random() * 10) + 4; // 4-14 days\n  confidence = 0.7 + (Math.random() * 0.15); // 0.7-0.85\n} else if (failureProbability > 0.4) {\n  priority = \"MEDIUM\";\n  timeline = Math.floor(Math.random() * 15) + 15; // 15-30 days\n  confidence = 0.6 + (Math.random() * 0.2); // 0.6-0.8\n} else {\n  priority = \"LOW\";\n  timeline = Math.floor(Math.random() * 60) + 31; // 31-90 days\n  confidence = 0.5 + (Math.random() * 0.3); // 0.5-0.8\n}\n\n// Generate root causes\nconst rootCauses = [];\nif (criticalComponent.name === \"Battery\") {\n  if (sensorData.battery_voltage < 11.5) rootCauses.push(\"Battery needs immediate replacement\");\n  else rootCauses.push(\"Battery showing signs of wear\");\n  rootCauses.push(\"Check alternator output\");\n  rootCauses.push(\"Inspect battery terminals for corrosion\");\n} else if (criticalComponent.name === \"Engine\") {\n  if (sensorData.engine_temp > 100) rootCauses.push(\"Cooling system malfunction\");\n  if (sensorData.oil_pressure < 30) rootCauses.push(\"Oil pump or filter issues\");\n  rootCauses.push(\"Schedule engine diagnostic\");\n} else if (criticalComponent.name === \"Brakes\") {\n  rootCauses.push(\"Brake pads at critical wear level\");\n  rootCauses.push(\"Inspect brake rotors and fluid\");\n} else if (criticalComponent.name === \"Tires\") {\n  rootCauses.push(\"Low tire pressure detected\");\n  rootCauses.push(\"Check for punctures or leaks\");\n}\n\n// Recommended actions\nconst actions = {\n  \"CRITICAL\": \"IMMEDIATE SERVICE REQUIRED - Do not operate vehicle\",\n  \"HIGH\": \"Schedule urgent service within 3 days\",\n  \"MEDIUM\": \"Schedule service within 2 weeks\", \n  \"LOW\": \"Monitor and address during next maintenance\"\n};\n\nreturn [{\n  json: {\n    ...data,\n    component: criticalComponent.name,\n    failure_probability: Math.round(failureProbability * 1000) / 1000,\n    confidence_score: Math.round(confidence * 1000) / 1000,\n    priority: priority,\n    timeline_days: timeline,\n    recommended_action: actions[priority],\n    root_cause_hypothesis: rootCauses,\n    all_component_scores: components,\n    analyzed_at: new Date().toISOString(),\n    diagnosis_id: `DIAG_${Date.now()}_${data.vehicle_id}`\n  }\n}];"
      },
      "id": "b9d77133-1e92-46d6-8947-b723881b7b25",
      "name": "Run ML Diagnosis (Mock)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        208
      ]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.priority }}",
        "rules": {
          "rules": [
            {
              "value2": "CRITICAL"
            },
            {
              "value2": "HIGH"
            },
            {
              "value2": "MEDIUM"
            },
            {
              "value2": "LOW"
            }
          ]
        }
      },
      "id": "92bdc061-cb5e-4af6-b218-142908214e95",
      "name": "Route by Priority",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        -304,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const diagnosis = $input.first().json;\n\nconst alertMessage = `ðŸš¨ CRITICAL VEHICLE ALERT ðŸš¨\n\nVehicle: ${diagnosis.vehicle_id} (${diagnosis.make} ${diagnosis.model})\nComponent: ${diagnosis.component}\nFailure Probability: ${(diagnosis.failure_probability * 100).toFixed(1)}%\nEstimated Timeline: ${diagnosis.timeline_days} days\nConfidence Score: ${(diagnosis.confidence_score * 100).toFixed(1)}%\n\nRECOMMENDED ACTION:\n${diagnosis.recommended_action}\n\nROOT CAUSE HYPOTHESES:\n${diagnosis.root_cause_hypothesis.map(cause => `â€¢ ${cause}`).join('\\n')}\n\nSENSOR READINGS:\nâ€¢ Battery Voltage: ${diagnosis.sensor_data.battery_voltage}V\nâ€¢ Engine Temp: ${diagnosis.sensor_data.engine_temp}Â°C\nâ€¢ Oil Pressure: ${diagnosis.sensor_data.oil_pressure} psi\nâ€¢ Brake Pad Thickness: ${diagnosis.sensor_data.brake_pad_thickness}mm\n\nDiagnosis ID: ${diagnosis.diagnosis_id}\nTimestamp: ${new Date().toLocaleString()}\n\nIMMEDIATE ATTENTION REQUIRED!`;\n\nreturn [{\n  json: {\n    ...diagnosis,\n    alert_message: alertMessage,\n    notification_type: \"CRITICAL_ALERT\",\n    alert_sent_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "3121e390-70e4-4b3b-956b-50a38827f566",
      "name": "Format Critical Alert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const alert = $input.first().json;\n\n// In production, this would connect to:\n// - Telegram Bot\n// - Slack Webhook  \n// - Email\n// - SMS\n// - PagerDuty\n\nconsole.log(\"=== CRITICAL VEHICLE ALERT ===\");\nconsole.log(alert.alert_message);\nconsole.log(\"===============================\");\n\n// Simulate sending to multiple channels\nconst notifications = [\n  \"console_log\",\n  \"telegram_bot\",\n  \"email_alert\"\n];\n\nreturn [{\n  json: {\n    ...alert,\n    notifications_sent: notifications,\n    final_alert_status: \"DELIVERED\",\n    response_time: \"immediate\"\n  }\n}];"
      },
      "id": "3cd1c62f-ec57-4762-8b94-34e9c6a5838d",
      "name": "Send Critical Alert (Mock)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const diagnosis = $input.first().json;\n\nconst ticketData = {\n  ticket_id: `TKT_${Date.now()}`,\n  vehicle_id: diagnosis.vehicle_id,\n  vehicle_info: `${diagnosis.make} ${diagnosis.model} (${diagnosis.year})`,\n  priority: diagnosis.priority,\n  component: diagnosis.component,\n  failure_probability: diagnosis.failure_probability,\n  timeline_days: diagnosis.timeline_days,\n  recommended_action: diagnosis.recommended_action,\n  root_causes: diagnosis.root_cause_hypothesis,\n  sensor_data: diagnosis.sensor_data,\n  created_at: new Date().toISOString(),\n  status: \"OPEN\",\n  assigned_team: \"URGENT_MAINTENANCE\",\n  estimated_repair_time: \"2-4 hours\",\n  parts_required: [\"Diagnostic tool\", \"Replacement parts\"],\n  notes: \"Auto-generated from AI diagnosis system\"\n};\n\nconsole.log(`ðŸŽ« Created maintenance ticket: ${ticketData.ticket_id}`);\nconsole.log(`   Vehicle: ${ticketData.vehicle_info}`);\nconsole.log(`   Priority: ${ticketData.priority}`);\n\nreturn [{\n  json: {\n    ...diagnosis,\n    maintenance_ticket: ticketData,\n    ticket_created: true,\n    ticket_timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "cfe059c4-1f15-48a9-b0a0-1218fbe227d1",
      "name": "Create High Priority Ticket",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "const diagnosis = $input.first().json;\n\nconst logEntry = {\n  log_id: `LOG_${Date.now()}`,\n  vehicle_id: diagnosis.vehicle_id,\n  priority: diagnosis.priority,\n  component: diagnosis.component,\n  failure_probability: diagnosis.failure_probability,\n  timeline_days: diagnosis.timeline_days,\n  confidence: diagnosis.confidence_score,\n  logged_at: new Date().toISOString(),\n  action: \"SCHEDULE_NEXT_MAINTENANCE\",\n  follow_up: \"Check during next service appointment\",\n  severity: \"MODERATE\"\n};\n\nconsole.log(`ðŸ“ Logged medium priority diagnosis for ${diagnosis.vehicle_id}`);\n\nreturn [{\n  json: {\n    ...diagnosis,\n    database_log: logEntry,\n    stored_in_database: true,\n    requires_immediate_action: false\n  }\n}];"
      },
      "id": "b77b6176-8dd9-4e2f-9f07-c90e9c5e8d55",
      "name": "Log Diagnosis to Database",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all();\n\nconst summary = {\n  total_vehicles: allItems.length,\n  critical_alerts: allItems.filter(item => item.json.priority === 'CRITICAL').length,\n  high_priority: allItems.filter(item => item.json.priority === 'HIGH').length,\n  medium_priority: allItems.filter(item => item.json.priority === 'MEDIUM').length,\n  low_priority: allItems.filter(item => item.json.priority === 'LOW').length,\n  workflow_run_id: `RUN_${Date.now()}`,\n  completed_at: new Date().toISOString(),\n  execution_time: \"5.2 seconds\",\n  system_status: \"OPERATIONAL\"\n};\n\n// Generate detailed report\nconst criticalVehicles = allItems\n  .filter(item => item.json.priority === 'CRITICAL')\n  .map(item => item.json.vehicle_id);\n\nconst summaryMessage = `\nâœ… VEHICLE DIAGNOSIS WORKFLOW COMPLETE\n\nSUMMARY REPORT:\nâ€¢ Total Vehicles Processed: ${summary.total_vehicles}\nâ€¢ ðŸš¨ Critical Alerts: ${summary.critical_alerts}\nâ€¢ ðŸ”´ High Priority: ${summary.high_priority} \nâ€¢ ðŸŸ¡ Medium Priority: ${summary.medium_priority}\nâ€¢ ðŸŸ¢ Low Priority: ${summary.low_priority}\n\nCRITICAL VEHICLES REQUIRING IMMEDIATE ATTENTION:\n${criticalVehicles.length > 0 ? criticalVehicles.map(v => `â€¢ ${v}`).join('\\n') : 'â€¢ None'}\n\nWorkflow Run: ${summary.workflow_run_id}\nCompleted: ${new Date().toLocaleString()}\nSystem: ${summary.system_status}\n`;\n\nconsole.log(\"===========================================\");\nconsole.log(summaryMessage);\nconsole.log(\"===========================================\");\n\nreturn [{\n  json: {\n    workflow_summary: summary,\n    summary_message: summaryMessage,\n    alert_required: summary.critical_alerts > 0,\n    success: true\n  }\n}];"
      },
      "id": "72ed1670-43d4-4906-a947-424de7dc9647",
      "name": "Generate Workflow Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const diagnosis = $input.first().json;\n\nconst logEntry = {\n  log_id: `LOG_${Date.now()}`,\n  vehicle_id: diagnosis.vehicle_id,\n  priority: diagnosis.priority,\n  component: diagnosis.component,\n  failure_probability: diagnosis.failure_probability,\n  timeline_days: diagnosis.timeline_days,\n  confidence: diagnosis.confidence_score,\n  logged_at: new Date().toISOString(),\n  action: \"MONITOR_ONLY\",\n  follow_up: \"Routine monitoring\",\n  severity: \"LOW\"\n};\n\nconsole.log(`ðŸ“‹ Logged low priority diagnosis for ${diagnosis.vehicle_id}`);\n\nreturn [{\n  json: {\n    ...diagnosis,\n    database_log: logEntry,\n    stored_in_database: true,\n    requires_immediate_action: false,\n    status: \"HEALTHY\"\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32,
        672
      ],
      "id": "687af60f-952b-4776-8f63-9927a00b7698",
      "name": "Code in JavaScript"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Get Vehicles (Mock)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Vehicles (Mock)": {
      "main": [
        [
          {
            "node": "Split Out Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Vehicles": {
      "main": [
        [
          {
            "node": "Get Sensor Data (Mock)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Sensor Data (Mock)": {
      "main": [
        [
          {
            "node": "Run ML Diagnosis (Mock)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run ML Diagnosis (Mock)": {
      "main": [
        [
          {
            "node": "Route by Priority",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Priority": {
      "main": [
        [
          {
            "node": "Format Critical Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create High Priority Ticket",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Diagnosis to Database",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Critical Alert": {
      "main": [
        [
          {
            "node": "Send Critical Alert (Mock)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Critical Alert (Mock)": {
      "main": [
        [
          {
            "node": "Generate Workflow Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create High Priority Ticket": {
      "main": [
        [
          {
            "node": "Generate Workflow Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Diagnosis to Database": {
      "main": [
        [
          {
            "node": "Generate Workflow Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Generate Workflow Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5b630b21-e3f6-46b6-bee8-190c1b4faeb7",
  "meta": {
    "instanceId": "9f03552fc0957eef9184f37510f8bebd3618c2a7adb03f7d2379b5fe146a71bd"
  },
  "id": "oRuFdmBuELqLAlrx",
  "tags": []
}